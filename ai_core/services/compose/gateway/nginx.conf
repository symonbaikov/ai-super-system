
worker_processes  1;
events { worker_connections 1024; }
http {
  sendfile on;
  server {
    listen 8080;
    # ACL: разрешить только приватные сети и localhost
    allow 127.0.0.1/32;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny  all;

    # Basic Auth
    auth_basic           "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # SCOUT (vLLM OpenAI API)
    location /api/scout/ {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      rewrite ^/api/scout/(.*)$ /$1 break;
      proxy_pass http://scout-llm:8000/;
    }

    # ANALYST (vLLM OpenAI API)
    location /api/analyst/ {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      rewrite ^/api/analyst/(.*)$ /$1 break;
      proxy_pass http://analyst-llm:8000/;
    }

    # JUDGE (vLLM OpenAI API)
    location /api/judge/ {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      rewrite ^/api/judge/(.*)$ /$1 break;
      proxy_pass http://judge-llm:8000/;
    }

    # JUDGE-LLAMACPP (llama.cpp server OpenAI-like API)
    location /api/judge-llamacpp/ {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      rewrite ^/api/judge-llamacpp/(.*)$ /$1 break;
      proxy_pass http://judge-llamacpp:8004/;
    }
  }
}
